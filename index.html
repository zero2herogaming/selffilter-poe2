<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PoE2 Filter Builder</title>
  <style>
    /* Overall Layout */
    body {
      margin: 0; 
      padding: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      background: #f0f0f0;
      color: #333;
    }
    #left-panel, #right-panel {
      padding: 1rem;
      overflow-y: auto;
    }
    #left-panel {
      width: 45%;
      background: #fff;
      border-right: 2px solid #ccc;
    }
    #right-panel {
      width: 55%;
      background: #f8f8f8;
    }

    /* HEADINGS */
    h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1.2rem;
      color: #222;
    }

    /* RULE CARDS */
    .rule-card {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 1rem;
      padding: 0.5rem 0.75rem;
    }
    .rule-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .rule-header h3 {
      margin: 0;
      font-size: 1rem;
      color: #444;
    }
    .rule-header button {
      padding: 0.3rem 0.6rem;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      background: #eee;
      cursor: pointer;
      border-radius: 4px;
    }
    .rule-header button:hover {
      background: #ddd;
    }
    .rule-body {
      display: flex; 
      flex-wrap: wrap;
      gap: 1rem;
    }
    .rule-body label {
      display: inline-block;
      margin-right: 0.5rem;
      margin-bottom: 0.3rem;
      font-size: 0.9rem;
    }
    .rule-body select, .rule-body input[type="number"], .rule-body input[type="color"] {
      margin-right: 0.3rem;
      font-size: 0.9rem;
    }

    /* BOTTOM BUTTONS / ETC. */
    #addRuleButton {
      display: inline-block;
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background: #4caf50;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    #addRuleButton:hover {
      background: #45a045;
    }

    /* RIGHT PANEL PREVIEW */
    #filterPreview {
      white-space: pre;
      background: #eee;
      padding: 0.75rem;
      height: calc(100% - 3.5rem);
      overflow-y: auto;
      font-family: monospace;
      border: 1px solid #ccc;
    }

    /* DOWNLOAD */
    #downloadBtn {
      display: inline-block;
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      background: #2196f3;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    #downloadBtn:hover {
      background: #1e88e5;
    }
    #download-link {
      display: none;
    }
  </style>
</head>
<body>
  <!-- LEFT: RULES & ADD RULE BUTTON -->
  <div id="left-panel">
    <h2>PoE2 Filter Rules</h2>
    <button id="addRuleButton">+ Add Rule</button>
    <div id="rulesContainer"></div>
  </div>

  <!-- RIGHT: PREVIEW & DOWNLOAD -->
  <div id="right-panel">
    <h2>Live Filter Preview</h2>
    <div id="filterPreview"></div>
    <button id="downloadBtn">Download Filter</button>
    <a id="download-link" href="#" download="my-filter.filter">Download Link</a>
  </div>

  <script>
    /***************************************************************
     * 1. Category Data
     ***************************************************************/
    // We'll define categories with items. 
    // For brevity, we only show a few from your examples. 
    // You can add more as needed.
    const CATEGORIES = [
      {
        id: "gems",
        name: "Gems (No Rarity / No Sockets)",
        isGemsCategory: true,
        items: [
          { name: "Uncut Spirit Gem",    usesItemLevel: true,  isStackable: false },
          { name: "Uncut Support Gem",   usesItemLevel: true,  isStackable: false },
          { name: "Uncut Skill Gem",     usesItemLevel: true,  isStackable: false },
          { name: "Soul Core",           usesItemLevel: false, isStackable: false },
          { name: "Timeless",            usesItemLevel: false, isStackable: false },
          { name: "Relic",               usesItemLevel: false, isStackable: false }
        ]
      },
      {
        id: "onehand",
        name: "One-Handed Weapons",
        isGemsCategory: false,
        items: [
          { name: "One Hand Maces", usesItemLevel: true, isStackable: false },
          { name: "Attuned Wand",   usesItemLevel: true, isStackable: false },
          { name: "Siphoning Wand", usesItemLevel: true, isStackable: false }
        ]
      },
      {
        id: "waystones",
        name: "Waystones",
        isGemsCategory: false,
        items: [
          { name: "Waystone", usesItemLevel: false, isStackable: true }
        ]
      },
      {
        id: "flasks",
        name: "Flasks",
        isGemsCategory: false,
        items: [
          { name: "Life Flask", usesItemLevel:false, isStackable:false },
          { name: "Mana Flask", usesItemLevel:false, isStackable:false },
          { name: "Ultimate Life Flask", usesItemLevel:false, isStackable:true },
          { name: "Ultimate Mana Flask", usesItemLevel:false, isStackable:true }
        ]
      }
      // TODO: Add more categories (Two-Handed, Off-hand, Armour, Jewellery, Currency, Jewels, etc.)
    ];

    /***************************************************************
     * 2. The "rules" array holds all user-defined rules
     ***************************************************************/
    let rules = [];

    /***************************************************************
     * 3. "Add Rule" => create a new rule card
     ***************************************************************/
    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("addRuleButton").addEventListener("click", createRuleCard);
      document.getElementById("downloadBtn").addEventListener("click", downloadFilter);
      renderPreview(); // initially empty
    });

    function createRuleCard() {
      // We'll create a blank rule object
      const newRule = {
        categoryId: CATEGORIES[0].id, // default
        itemName: CATEGORIES[0].items[0].name,
        showHide: "Show",
        rarities: [],
        socketsVal: 0,
        qualityVal: 0,
        itemLevelVal: 0,
        stackVal: 0,
        areaOp: "",
        areaVal: 0,
        textC: "#ffffff",
        borderC: "#ffffff",
        bgC: "#000000",
        fontC: 35,
        alertSound: "",
        alertDur: 300,
        mmSize: "",
        mmColor: "",
        mmShape: ""
      };
      rules.push(newRule);
      renderRules();
      renderPreview();
    }

    /***************************************************************
     * 4. RENDER ALL RULE CARDS
     ***************************************************************/
    function renderRules() {
      const container = document.getElementById("rulesContainer");
      container.innerHTML = "";
      rules.forEach((rule, index) => {
        const card = document.createElement("div");
        card.classList.add("rule-card");

        // Card header
        const header = document.createElement("div");
        header.classList.add("rule-header");
        const title = document.createElement("h3");
        title.textContent = `Rule ${index+1}`;
        const removeBtn = document.createElement("button");
        removeBtn.textContent = "Remove";
        removeBtn.addEventListener("click", () => {
          rules.splice(index, 1);
          renderRules();
          renderPreview();
        });
        header.appendChild(title);
        header.appendChild(removeBtn);
        card.appendChild(header);

        // Card body
        const body = document.createElement("div");
        body.classList.add("rule-body");
        
        // 1) Category
        const catLabel = document.createElement("label");
        catLabel.textContent = "Category: ";
        const catSelect = document.createElement("select");
        CATEGORIES.forEach(cat => {
          const opt = document.createElement("option");
          opt.value = cat.id;
          opt.textContent = cat.name;
          if (cat.id === rule.categoryId) opt.selected = true;
          catSelect.appendChild(opt);
        });
        catLabel.appendChild(catSelect);
        body.appendChild(catLabel);

        // 2) Item
        const itemLabel = document.createElement("label");
        itemLabel.textContent = " Item: ";
        const itemSelect = document.createElement("select");
        itemLabel.appendChild(itemSelect);
        body.appendChild(itemLabel);

        // a function to fill itemSelect based on the chosen category
        function fillItemSelect(catId, ruleObj) {
          itemSelect.innerHTML = "";
          const catObj = CATEGORIES.find(c=> c.id===catId);
          if (!catObj) return;
          catObj.items.forEach(it => {
            const opt = document.createElement("option");
            opt.value = it.name;
            opt.textContent = it.name;
            if (it.name=== ruleObj.itemName) opt.selected = true;
            itemSelect.appendChild(opt);
          });
        }
        fillItemSelect(rule.categoryId, rule);

        // 3) Show/Hide
        const showHideLabel = document.createElement("label");
        showHideLabel.textContent = " Action: ";
        const showHideSel = document.createElement("select");
        ["Show", "Hide"].forEach(val => {
          const opt = document.createElement("option");
          opt.value= val; 
          opt.textContent = val;
          if (val===rule.showHide) opt.selected=true;
          showHideSel.appendChild(opt);
        });
        showHideLabel.appendChild(showHideSel);
        body.appendChild(showHideLabel);

        // 4) Rarity checkboxes (hidden if gems)
        const catObjRef = ()=> CATEGORIES.find(c=> c.id===rule.categoryId);
        const isGems = ()=> catObjRef()?.isGemsCategory===true;

        const rarityWrap = document.createElement("div");
        rarityWrap.style.display = isGems() ? "none" : "inline-block";
        rarityWrap.innerHTML = `
          <label><input type="checkbox" data-rarity="Normal"/> Normal</label>
          <label><input type="checkbox" data-rarity="Magic" /> Magic</label>
          <label><input type="checkbox" data-rarity="Rare"  /> Rare</label>
          <label><input type="checkbox" data-rarity="Unique"/> Unique</label>
        `;
        // We'll set .checked based on rule.rarities
        body.appendChild(rarityWrap);

        // 5) Sockets > X (hidden if gems)
        const socketsLabel = document.createElement("label");
        socketsLabel.style.display = isGems() ? "none":"inline-block";
        socketsLabel.innerHTML = ` Sockets >: <input type="number" style="width:50px;" value="${rule.socketsVal}"/>`;
        body.appendChild(socketsLabel);

        // 6) Quality
        const qualityLabel = document.createElement("label");
        qualityLabel.innerHTML = ` Quality >: <input type="number" style="width:50px;" value="${rule.qualityVal}" />`;
        body.appendChild(qualityLabel);

        // 7) itemLevel
        const itemLevelLabel = document.createElement("label");
        itemLevelLabel.innerHTML = ` ItemLevel =: <input type="number" style="width:50px;" value="${rule.itemLevelVal}"/>`;
        // we'll decide if we show or hide this later
        body.appendChild(itemLevelLabel);

        // 8) stackSize
        const stackLabel = document.createElement("label");
        stackLabel.innerHTML = ` StackSize >=: <input type="number" style="width:50px;" value="${rule.stackVal}"/>`;
        body.appendChild(stackLabel);

        // 9) areaLevel
        const areaWrap = document.createElement("label");
        areaWrap.innerHTML = ` AreaLevel: 
          <select>
            <option value="">None</option>
            <option value=">=" ${rule.areaOp===">="?"selected":""}>>=</option>
            <option value="<=" ${rule.areaOp==="<="?"selected":""}>&lt;=</option>
            <option value="="  ${rule.areaOp==="=" ?"selected":""}>=</option>
          </select>
          <input type="number" style="width:50px;" value="${rule.areaVal}"/>
        `;
        body.appendChild(areaWrap);

        // 10) colors
        const textColorLabel = document.createElement("label");
        textColorLabel.innerHTML = ` TextColor: <input type="color" value="${rule.textC}"/>`;
        body.appendChild(textColorLabel);

        const borderColorLabel = document.createElement("label");
        borderColorLabel.innerHTML = ` BorderColor: <input type="color" value="${rule.borderC}"/>`;
        body.appendChild(borderColorLabel);

        const bgColorLabel = document.createElement("label");
        bgColorLabel.innerHTML = ` Background: <input type="color" value="${rule.bgC}"/>`;
        body.appendChild(bgColorLabel);

        const fontSizeLabel = document.createElement("label");
        fontSizeLabel.innerHTML = ` FontSize: <input type="number" style="width:45px;" value="${rule.fontC}" min="12" max="60"/>`;
        body.appendChild(fontSizeLabel);

        // 11) Alert Sound
        const alertWrap = document.createElement("label");
        alertWrap.innerHTML = ` Alert Sound:
          <select>
            <option value="">None</option>
            <option value="1"  ${rule.alertSound==="1" ?"selected":""}>1</option>
            <option value="2"  ${rule.alertSound==="2" ?"selected":""}>2</option>
            <option value="3"  ${rule.alertSound==="3" ?"selected":""}>3</option>
            <option value="4"  ${rule.alertSound==="4" ?"selected":""}>4</option>
            <option value="6"  ${rule.alertSound==="6" ?"selected":""}>6</option>
            <option value="10" ${rule.alertSound==="10"?"selected":""}>10</option>
          </select>
          <input type="number" style="width:55px;" value="${rule.alertDur}" min="50" max="1000"/>
        `;
        body.appendChild(alertWrap);

        // 12) MinimapIcon
        const mmWrap = document.createElement("div");
        mmWrap.innerHTML = `
          <label>Minimap Icon:
            Size:
            <select>
              <option value="">None</option>
              <option value="0" ${rule.mmSize==="0"?"selected":""}>0</option>
              <option value="1" ${rule.mmSize==="1"?"selected":""}>1</option>
              <option value="2" ${rule.mmSize==="2"?"selected":""}>2</option>
              <option value="3" ${rule.mmSize==="3"?"selected":""}>3</option>
            </select>
            Color:
            <select>
              <option value="">None</option>
              <option value="White"  ${rule.mmColor==="White"?"selected":""}>White</option>
              <option value="Red"    ${rule.mmColor==="Red"?"selected":""}>Red</option>
              <option value="Blue"   ${rule.mmColor==="Blue"?"selected":""}>Blue</option>
              <option value="Green"  ${rule.mmColor==="Green"?"selected":""}>Green</option>
              <option value="Brown"  ${rule.mmColor==="Brown"?"selected":""}>Brown</option>
              <option value="Yellow" ${rule.mmColor==="Yellow"?"selected":""}>Yellow</option>
              <option value="Cyan"   ${rule.mmColor==="Cyan"?"selected":""}>Cyan</option>
              <option value="Grey"   ${rule.mmColor==="Grey"?"selected":""}>Grey</option>
            </select>
            Shape:
            <select>
              <option value="">None</option>
              <option value="Square"   ${rule.mmShape==="Square"?"selected":""}>Square</option>
              <option value="Circle"   ${rule.mmShape==="Circle"?"selected":""}>Circle</option>
              <option value="Star"     ${rule.mmShape==="Star"?"selected":""}>Star</option>
              <option value="Diamond"  ${rule.mmShape==="Diamond"?"selected":""}>Diamond</option>
              <option value="Triangle" ${rule.mmShape==="Triangle"?"selected":""}>Triangle</option>
              <option value="Kite"     ${rule.mmShape==="Kite"?"selected":""}>Kite</option>
            </select>
          </label>
        `;
        body.appendChild(mmWrap);

        // put the body in the card
        card.appendChild(body);

        // Append to container
        container.appendChild(card);

        // Now we attach event listeners to all these fields so that any change => update rule => re-render preview

        // CatSelect => change items 
        catSelect.addEventListener("change", ()=> {
          rule.categoryId = catSelect.value;
          // reset itemName to first in that cat
          const newCatObj = CATEGORIES.find(c=> c.id===rule.categoryId);
          if (newCatObj?.items?.length>0) {
            rule.itemName = newCatObj.items[0].name;
          }
          // re-fill itemSelect
          fillItemSelect(rule.categoryId, rule);
          // update "isGemsCategory"
          updateRaritySocketsVisibility(rarityWrap, socketsLabel, rule.categoryId);
          updateItemLevelStackVisibility(itemLevelLabel, stackLabel, rule);
          renderPreview();
        });

        // itemSelect => change rule.itemName
        itemSelect.addEventListener("change", ()=> {
          rule.itemName = itemSelect.value;
          renderPreview();
          updateItemLevelStackVisibility(itemLevelLabel, stackLabel, rule);
        });

        // showHideSel
        showHideSel.addEventListener("change", ()=> {
          rule.showHide = showHideSel.value;
          renderPreview();
        });

        // handle rarities
        rarityWrap.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          const rar = cb.getAttribute("data-rarity");
          cb.checked = rule.rarities.includes(rar);
          cb.addEventListener("change", ()=> {
            if (cb.checked) {
              if (!rule.rarities.includes(rar)) rule.rarities.push(rar);
            } else {
              rule.rarities = rule.rarities.filter(rn => rn!==rar);
            }
            renderPreview();
          });
        });

        // sockets
        const socketsInput = socketsLabel.querySelector('input[type="number"]');
        socketsInput.addEventListener("change", ()=> {
          rule.socketsVal = parseInt(socketsInput.value||"0",10);
          renderPreview();
        });

        // quality
        const qualityInput = qualityLabel.querySelector('input[type="number"]');
        qualityInput.addEventListener("change", ()=> {
          rule.qualityVal = parseInt(qualityInput.value||"0",10);
          renderPreview();
        });

        // itemlevel
        const lvlInput = itemLevelLabel.querySelector('input[type="number"]');
        lvlInput.addEventListener("change", ()=> {
          rule.itemLevelVal = parseInt(lvlInput.value||"0",10);
          renderPreview();
        });

        // stacksize
        const stInput = stackLabel.querySelector('input[type="number"]');
        stInput.addEventListener("change", ()=> {
          rule.stackVal = parseInt(stInput.value||"0",10);
          renderPreview();
        });

        // areaLevel
        const areaSel = areaWrap.querySelector('select');
        const areaNum = areaWrap.querySelector('input[type="number"]');
        areaSel.addEventListener("change", ()=> {
          rule.areaOp = areaSel.value;
          renderPreview();
        });
        areaNum.addEventListener("change", ()=> {
          rule.areaVal = parseInt(areaNum.value||"0",10);
          renderPreview();
        });

        // text color
        const textColorInput = textColorLabel.querySelector('input[type="color"]');
        textColorInput.addEventListener("change", ()=> {
          rule.textC = textColorInput.value;
          renderPreview();
        });

        // border color
        const borderColorInput = borderColorLabel.querySelector('input[type="color"]');
        borderColorInput.addEventListener("change", ()=> {
          rule.borderC = borderColorInput.value;
          renderPreview();
        });

        // background
        const bgColorInput = bgColorLabel.querySelector('input[type="color"]');
        bgColorInput.addEventListener("change", ()=> {
          rule.bgC = bgColorInput.value;
          renderPreview();
        });

        // font
        const fontInput = fontSizeLabel.querySelector('input[type="number"]');
        fontInput.addEventListener("change", ()=> {
          rule.fontC = parseInt(fontInput.value||"35",10);
          renderPreview();
        });

        // alert sound
        const soundSel = alertWrap.querySelector('select');
        const soundNum = alertWrap.querySelector('input[type="number"]');
        soundSel.addEventListener("change", ()=> {
          rule.alertSound = soundSel.value;
          renderPreview();
        });
        soundNum.addEventListener("change", ()=> {
          rule.alertDur = parseInt(soundNum.value||"300",10);
          renderPreview();
        });

        // minimap
        const mmSelects = mmWrap.querySelectorAll("select");
        mmSelects[0].addEventListener("change", ()=> {
          rule.mmSize = mmSelects[0].value;
          renderPreview();
        });
        mmSelects[1].addEventListener("change", ()=> {
          rule.mmColor= mmSelects[1].value;
          renderPreview();
        });
        mmSelects[2].addEventListener("change", ()=> {
          rule.mmShape= mmSelects[2].value;
          renderPreview();
        });

        // after creation, we set up the initial visibility
        updateRaritySocketsVisibility(rarityWrap, socketsLabel, rule.categoryId);
        updateItemLevelStackVisibility(itemLevelLabel, stackLabel, rule);
      });
    }

    function updateRaritySocketsVisibility(rarityWrap, socketsLabel, catId) {
      const cat = CATEGORIES.find(c=> c.id===catId);
      if (!cat) return;
      if (cat.isGemsCategory) {
        rarityWrap.style.display = "none";
        socketsLabel.style.display = "none";
      } else {
        rarityWrap.style.display = "inline-block";
        socketsLabel.style.display = "inline-block";
      }
    }
    function updateItemLevelStackVisibility(itemLevelLabel, stackLabel, ruleObj) {
      // find cat
      const cat = CATEGORIES.find(c=> c.id===ruleObj.categoryId);
      if (!cat) return;
      const itemData = cat.items.find(i=> i.name=== ruleObj.itemName);
      if (!itemData) return;
      itemLevelLabel.style.display = itemData.usesItemLevel ? "inline-block":"none";
      stackLabel.style.display = itemData.isStackable ? "inline-block":"none";
    }

    /***************************************************************
     * 5. RENDER PREVIEW
     ***************************************************************/
    function renderPreview() {
      const preview = document.getElementById("filterPreview");
      preview.textContent = generateFullFilter();
    }

    function generateFullFilter() {
      let content = "";
      rules.forEach(r => {
        let block = r.showHide+"\n";
        if (r.rarities?.length>0) {
          block += "  Rarity "+r.rarities.join(" ")+"\n";
        }
        if (r.socketsVal>0) {
          block += `  Sockets > ${r.socketsVal}\n`;
        }
        if (r.qualityVal>0) {
          block += `  Quality > ${r.qualityVal}\n`;
        }
        if (r.itemLevelVal>0) {
          block += `  ItemLevel = ${r.itemLevelVal}\n`;
        }
        if (r.stackVal>0) {
          block += `  StackSize >= ${r.stackVal}\n`;
        }
        if (r.areaOp && r.areaVal>0) {
          block += `  AreaLevel ${r.areaOp} ${r.areaVal}\n`;
        }
        // find item data to know if isStackable => BaseType or Class
        const cat = CATEGORIES.find(c=> c.id===r.categoryId);
        const itemData = cat?.items.find(i=> i.name===r.itemName);
        if (itemData && itemData.isStackable) {
          block += `  BaseType "${r.itemName}"\n`;
        } else {
          block += `  Class "${r.itemName}"\n`;
        }
        if (r.textC) {
          block += `  SetTextColor ${hexToRGB(r.textC)}\n`;
        }
        if (r.borderC) {
          block += `  SetBorderColor ${hexToRGB(r.borderC)}\n`;
        }
        if (r.bgC && r.bgC.toLowerCase()!=="#ffffff") {
          block += `  SetBackgroundColor ${hexToRGB(r.bgC)}\n`;
        }
        if (r.fontC) {
          block += `  SetFontSize ${r.fontC}\n`;
        }
        if (r.alertSound) {
          block += `  PlayAlertSound ${r.alertSound} ${r.alertDur}\n`;
        }
        if (r.mmSize && r.mmColor && r.mmShape) {
          block += `  MinimapIcon ${r.mmSize} ${r.mmColor} ${r.mmShape}\n`;
        }
        block += "\n";
        content += block;
      });
      return content.trim();
    }

    /***************************************************************
     * 6. DOWNLOAD
     ***************************************************************/
    function downloadFilter() {
      const filterText = generateFullFilter();
      const blob = new Blob([filterText], { type:"text/plain" });
      const url = URL.createObjectURL(blob);
      const link = document.getElementById("download-link");
      link.href = url;
      link.click();
    }
  </script>
</body>
</html>
